<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultimate Image Editor</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: #f9f9f9;
    color: #222;
  }
  h1 {
    text-align: center;
    margin-bottom: 1rem;
  }
  .warning {
    background: #ffe6e6;
    border: 1px solid #ff0000;
    color: #900;
    padding: 1rem;
    margin-bottom: 2rem;
  }
  form {
    background: #fff;
    padding: 1rem 2rem;
    border-radius: 8px;
    max-width: 600px;
    margin: 0 auto 2rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-bottom: 0.8rem;
  }
  input[type="number"],
  select,
  textarea,
  input[type="text"] {
    width: 100%;
    padding: 0.4rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  .inline-label {
    display: inline-block;
    margin-right: 1rem;
  }
  button {
    background: #007bff;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1.1rem;
  }
  button:hover {
    background: #0056b3;
  }
  .preview {
    text-align: center;
  }
  .preview img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .presets {
    max-width: 600px;
    margin: 0 auto 1rem;
  }
  .presets button {
    margin: 0 0.5rem 0.5rem 0;
    background: #28a745;
  }
</style>
</head>
<body>
<h1>Ultimate Image Editor</h1>

<div class="warning">
  <strong>Warning:</strong> Embedding executable code in images can be extremely dangerous and is not supported by most image viewers. Use with caution.
</div>

<div class="presets">
  <strong>Presets:</strong>
  <button type="button" data-preset="none">Clear</button>
  <button type="button" data-preset="calculator">Calculator Launcher</button>
  <button type="button" data-preset="link">Add URL Link</button>
</div>

<form id="editForm" enctype="multipart/form-data">
  <label>
    Upload Image:
    <input type="file" name="image" accept="image/*" required />
  </label>

  <label>
    Width:
    <input type="number" name="width" readonly />
  </label>

  <label>
    Height:
    <input type="number" name="height" readonly />
  </label>

  <label>
    Format:
    <select name="format" required>
      <option value="jpeg">JPEG</option>
      <option value="png">PNG</option>
      <option value="webp">WebP</option>
    </select>
  </label>

  <label>
    Metadata (JSON):
    <textarea name="metadata" placeholder='{"Artist":"Your Name","Copyright":"Â© 2025"}'></textarea>
  </label>

  <label>
    <input type="checkbox" name="embedCodeEnabled" />
    Embed Executable Code (dangerous, use with caution)
  </label>

  <label>
    Executable Code (Optional, only added if above enabled):
    <textarea name="embedCode" placeholder="JavaScript or other code to embed"></textarea>
  </label>

  <button type="submit">Process & Download</button>
</form>

<div class="preview" aria-live="polite" aria-atomic="true">
  <h2>Preview</h2>
  <img id="previewImage" alt="Processed image preview will appear here." />
</div>

<script>
  const form = document.getElementById('editForm');
  const previewImage = document.getElementById('previewImage');
  const widthInput = form.elements['width'];
  const heightInput = form.elements['height'];
  const fileInput = form.elements['image'];
  const metadataTextarea = form.elements['metadata'];
  const embedCodeCheckbox = form.elements['embedCodeEnabled'];
  const embedCodeTextarea = form.elements['embedCode'];

  // Presets metadata and embedCode data
  const presets = {
    none: { metadata: '', embedCode: '', embedCodeEnabled: false },
    calculator: {
      metadata: JSON.stringify({ Description: "Launch Calculator on open" }),
      embedCodeEnabled: true,
      embedCode: "alert('Calculator launch code would execute here (demo)');"
    },
    link: {
      metadata: JSON.stringify({ URL: "https://example.com" }),
      embedCodeEnabled: false,
      embedCode: ""
    }
  };

  // Set preset data to form fields
  document.querySelectorAll('.presets button').forEach(button => {
    button.addEventListener('click', () => {
      const presetName = button.getAttribute('data-preset');
      const preset = presets[presetName];
      metadataTextarea.value = preset.metadata;
      embedCodeTextarea.value = preset.embedCode;
      embedCodeCheckbox.checked = preset.embedCodeEnabled;
    });
  });

  // Auto-fill width and height on image load
  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = function() {
      widthInput.value = img.width;
      heightInput.value = img.height;
    };
    img.src = URL.createObjectURL(file);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!fileInput.files[0]) {
      alert('Please select an image file');
      return;
    }

    const formData = new FormData(form);

    try {
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('Server error: ' + response.statusText);
      }

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);

      previewImage.src = url;

      // Trigger download automatically
      const a = document.createElement('a');
      a.href = url;
      a.download = 'processed-image.' + formData.get('format');
      document.body.appendChild(a);
      a.click();
      a.remove();

    } catch (error) {
      alert('Error: ' + error.message);
    }
  });
</script>
</body>
</html>
